C51 COMPILER V9.00   ADC                                                                   04/22/2016 01:08:11 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ADC
OBJECT MODULE PLACED IN ..\bin\adc.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\HARDWARE\adc.c BROWSE INCDIR(..\HARDWARE;..\USER) DEBUG OBJECTEXTEND PRI
                    -NT(.\adc.lst) OBJECT(..\bin\adc.obj)

line level    source

   1          /*
   2          在中断中读取votage_input值，100ms一次，在adc_start中实现循环，pid控制
   3          */
   4          #include "stc12c5a60s2.h"
   5          #include "intrins.h"
   6          #include "adc.h"
   7          #include "PID.h"
   8          #include "key.h"
   9          #include "pwm.h"
  10          #include "lcd1602.h"
  11          
  12          
  13          #define U8 unsigned char
  14          #define uint unsigned int
  15          #define uchar unsigned char
  16          
  17          
  18          #define ADC_POWER   0x80            //ADC power control bit 电源控制位
  19          #define ADC_FLAG    0x10            //ADC complete flag   标志位
  20          #define ADC_START   0x08            //ADC start control bit 启动控制位
  21          #define ADC_SPEEDLL 0x00            //420 clocks
  22          #define ADC_SPEEDL  0x20            //280 clocks
  23          #define ADC_SPEEDH  0x40            //140 clocks
  24          #define ADC_SPEEDHH 0x60            //70 clocks
  25          
  26          unsigned char in_str[]="0.00V";
  27          unsigned char d[5];
  28          uint  ch=0, counter=10;
  29          uint votage_input, key_input;
  30           
  31          
  32          void  ADC_Init();                               // 初始化AD
  33          void  Delay(unsigned int z);    // 延时
  34          void  view_Votage();
  35          void  view_SetVotage();
  36          
  37          
  38          void ADC_start()
  39          {
  40   1              uint a = 0;
  41   1              
  42   1              PWM_Initial();
  43   1              PWM_clock(2);      // PCA/PWM时钟源为 定时器0的溢出
  44   1              PWM0_set(240); //0全开，作为对比
  45   1              while(1)
  46   1              {  
  47   2                      view_Votage();
  48   2                      view_SetVotage();
  49   2                      a = KeyPro();  //********************************为后期键盘准备,目前只取key3 =0，key4=1
  50   2                      if(a==0) KeyDown();
  51   2                      if(a==1) KeyUp();               
  52   2              }
  53   1      }  
  54          
C51 COMPILER V9.00   ADC                                                                   04/22/2016 01:08:11 PAGE 2   

  55          void view_Votage()
  56          {
  57   1               uint K = 0;
  58   1                
  59   1              votage_input =votage_input&0xff;
  60   1              K =   (uint)((4700l*votage_input)/255);
  61   1              compare_temper(K);
  62   1              in_str[1] = K / 1000;     //最高位
  63   1              K = K % 1000;
  64   1              in_str[2] = K / 100;            //次高位
  65   1              K = K % 100;
  66   1              in_str[3] = K /10;                      //...
  67   1              in_str[4] = K % 10;                     //....
  68   1      
  69   1      
  70   1              num_lcdDis(0,0x06,in_str[4],2);
  71   1              num_lcdDis(0,0x05,in_str[3],2);
  72   1              num_lcdDis(0,0x04,in_str[2],2);
  73   1              num_lcdDis(0,0x03,in_str[1],2);
  74   1              num_lcdDis(0,0x02,0,2);
  75   1       
  76   1       
  77   1      }
  78          void view_SetVotage()
  79          {
  80   1              uint L = 0;
  81   1      
  82   1              L = getTemperSet();
  83   1              d[1] = L / 1000;          //最高位
  84   1              L = L % 1000;
  85   1              d[2] = L / 100;                 //次高位
  86   1              L = L % 100;
  87   1              d[3] = L /10;                   //...
  88   1              d[4] = L % 10;                  //....
  89   1              
  90   1              num_lcdDis(1,0x06,d[4],2);
  91   1              num_lcdDis(1,0x05,d[3],2);
  92   1              num_lcdDis(1,0x04,d[2],2);
  93   1              num_lcdDis(1,0x03,d[1],2);
  94   1              num_lcdDis(1,0x02,d[0],2);
  95   1      
  96   1      
  97   1      }
  98          
  99          
 100          void ADC_Init()
 101          {
 102   1      
 103   1          ADC_RES = 0;                                           //清除上次采集的结果 
 104   1              IE=0xa0;
 105   1              P1ASF=0xe0;                                            //设置AD输入通道为 P1.0-1.2 
 106   1          ADC_CONTR = ADC_POWER | ADC_SPEEDLL | ADC_START|ch ;   //选择开启的通道
 107   1          Delay(2);                                              //上电启动AD转换的延时
 108   1      }
 109          
 110          
 111          void Delay(unsigned int n)
 112          {
 113   1              unsigned int x;
 114   1          while (n--)
 115   1                      {
 116   2                                x=5000;
C51 COMPILER V9.00   ADC                                                                   04/22/2016 01:08:11 PAGE 3   

 117   2                                while (x--);
 118   2                      }
 119   1      }
 120          
 121          
 122          void ADC_isr(void) interrupt 5 using 1   //中断服务程序,每100ms读一次AD
 123          {
 124   1      
 125   1              ADC_CONTR &= !ADC_FLAG; 
 126   1               
 127   1              if (ch==0  )             
 128   1               {
 129   2                      votage_input= ADC_RES;
 130   2               }
 131   1      /*      else if(ch==1)
 132   1              {
 133   1                 votage1_input = 127;
 134   1              } */
 135   1          if(++ch>1)
 136   1              ch=0;
 137   1       
 138   1              ADC_CONTR = ADC_POWER | ADC_SPEEDLL | ADC_START|ch ;
 139   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    514    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     19       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
